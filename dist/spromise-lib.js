/**
 * spromise Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 *
 * https://github.com/MiguelCastillo/spromise
 */

/**
 * spromise Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 */

var root=this;define("src/async",["require","exports","module"],function(e,t,n){function s(e){i(e)}var r=root,i;r.setImmediate?i=r.setImmediate:r.process&&typeof r.process.nextTick=="function"?i=r.process.nextTick:i=function(e){r.setTimeout(e,0)},s.delay=function(e,t,n){r.setTimeout(e.apply.bind(e,this,n||[]),t)},n.exports=s}),define("src/promise",["require","exports","module","src/async"],function(e,t,n){function o(e,t){if(this instanceof o==0)return new o(e,t);var n=this;t instanceof u==0&&(t=new u),n.then=function(n,r){return t.then(n,r)},n.resolve=function(){return t.transition(i.resolved,this,arguments),n},n.reject=function(){return t.transition(i.rejected,this,arguments),n},n.promise={then:n.then,always:n.always,done:n.done,"catch":n.fail,fail:n.fail,notify:n.notify,state:n.state},n.promise.promise=n.promise,n.then.constructor=o,n.then.stateManager=t,typeof e=="function"&&e.call(n,n.resolve,n.reject)}function u(e){this.state=i.pending,e&&e.state&&this.transition(e.state,e.context,e.value)}function a(e){this.promise=e}var r=e("src/async"),i={pending:0,always:1,resolved:2,rejected:3,notify:4},s=["pending","","resolved","rejected",""];o.prototype.delay=function(t){var n=this;return new o(function(e,i){n.then(function(){r.delay(e.bind(this),t,arguments)},i.bind(this))})},o.prototype.always=function(t){return this.then.stateManager.enqueue(i.always,t),this.promise},o.prototype.done=function(t){return this.then.stateManager.enqueue(i.resolved,t),this.promise},o.prototype.fail=o.prototype.catch=function(t){return this.then.stateManager.enqueue(i.rejected,t),this.promise},o.prototype.notify=function(t){return this.then.stateManager.enqueue(i.notify,t),this.promise},o.prototype.state=function(){return s[this.then.stateManager.state]},o.prototype.isPending=function(){return this.then.stateManager.state===i.pending},o.prototype.isResolved=function(){return this.then.stateManager.state===i.resolved},o.prototype.isRejected=function(){return this.then.stateManager.state===i.resolved},o.defer=function(){return new o},o.reject=function(){return new o(null,new u({context:this,value:arguments,state:i.rejected}))},o.resolve=o.thenable=function(e){return e instanceof o==1?e:e&&typeof e.then=="function"?new o(e.then):new o(null,new u({context:this,value:arguments,state:i.resolved}))},o.delay=function(t){var n=Array.prototype.slice(arguments,1);return new o(function(e){r.delay(e.bind(this),t,n)})},u.prototype.enqueue=function(e,t,n){var s=this,o=this.state;o?o===e||i.always===e?n?t.apply(s.context,s.value):r(function(){t.apply(s.context,s.value)}):i.notify===e&&(n?t.call(s.context,s.state,s.value):r(function(){t.call(s.context,s.state,s.value)})):(this.queue||(this.queue=[])).push({state:e,cb:t})},u.prototype.transition=function(e,t,n,r){if(this.state)return;this.state=e,this.context=t,this.value=n;if(this.queue){var i=this.queue,s=i.length,o=0,u;this.queue=null;while(o<s)u=i[o++],this.enqueue(u.state,u.cb,r)}},u.prototype.then=function(e,t){e=typeof e=="function"?e:null,t=typeof t=="function"?t:null;if(!e&&this.state===i.resolved||!t&&this.state===i.rejected)return new o(null,this);var n=new a(new o);return e||t?this.enqueue(i.notify,n.resolve(e,t)):this.enqueue(i.notify,n.notify()),n.promise},a.prototype.resolve=function(e,t){var n=this;return function(s,o){var u=s===i.resolved?e||t:t||e;try{n.finalize(s,this,[u.apply(this,o)])}catch(a){n.promise.reject.call(this,a)}}},a.prototype.notify=function(){var e=this;return function(n,r){e.finalize(n,this,r)}},a.prototype.chain=function(e){var t=this;return function(){t.resolved||(t.resolved=!0,t.finalize(e,this,arguments))}},a.prototype.finalize=function(e,t,n){try{this._finalize(e,t,n)}catch(r){this.promise.reject.call(t,r)}},a.prototype._finalize=function(e,t,n){var r=this.promise,s=n[0],u=s&&s.then,f,l;if(s===r)throw new TypeError("Resolution input must not be the promise being resolved");if(u&&u.constructor===o){u.stateManager.enqueue(i.notify,this.notify(),!0);return}f=u&&typeof u=="function"&&typeof s;if(f==="function"||f==="object")try{l=new a(r),u.call(s,l.chain(i.resolved),l.chain(i.rejected))}catch(c){l.resolved||r.reject.call(t,c)}else r.then.stateManager.transition(e,t,n,!0)},o.states=i,n.exports=o}),define("src/all",["require","exports","module","src/promise","src/async"],function(e,t,n){function s(e,t,n){return typeof e=="function"?e.apply(n,t||[]):e}function o(e){function a(){u--,u||n.resolve.call(o,t)}function f(e){return function(){t[e]=arguments.length===1?arguments[0]:arguments,a()}}function l(){var r,i,o;for(r=0,o=u;r<o;r++)i=e[r],i&&typeof i.then=="function"?i.then(f(r),n.reject):(t[r]=s(i),a())}e=e||[];var t=[],n=r.defer(),o=this,u=e.length;return e.length?(i(l),n):n.resolve(e)}var r=e("src/promise"),i=e("src/async");n.exports=o}),define("src/when",["require","exports","module","src/promise","src/all"],function(e,t,n){function s(){var e=this,t=arguments;return new r(function(n,r){i.call(e,t).then(function(t){n.apply(e,t)},function(t){r.call(e,t)})})}var r=e("src/promise"),i=e("src/all");n.exports=s}),define("src/race",["require","exports","module","src/promise"],function(e,t,n){function i(e){return e?new r(function(t,n){function o(){s||(s=!0,t.apply(this,arguments))}function u(){s||(s=!0,n.apply(this,arguments))}var r,i,s=!1;for(r=0,i=e.length;r<i;r++)e[r].then(o,u)}):r.resolve()}var r=e("src/promise");n.exports=i}),define("src/spromise",["require","exports","module","src/promise","src/async","src/when","src/all","src/race"],function(e,t,n){var r=e("src/promise");r.aync=e("src/async"),r.when=e("src/when"),r.all=e("src/all"),r.race=e("src/race"),n.exports=r});