/**
 * spromise Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 */

define("src/async",[],function(){function e(){function i(){return function(){try{t.apply(n,e[0])}catch(r){setTimeout(s(r),1)}}}function s(e){return function(){r(e)}}function o(e){r=e}var e=Array.prototype.slice.call(arguments),t=e.shift(),n=this,r=function(){};return setTimeout(i(),1),{fail:o}}return e}),define("src/promise",["src/async"],function(e){function i(e){return typeof e=="function"}function s(e){return typeof e=="object"}function o(e){return e===t.resolved}function u(e){return e===t.rejected}function a(e){return e===t.pending}function f(l){function v(e,t){var r=f();return l.done(N(r,n.resolve,e)),l.fail(N(r,n.reject,t)),r}function m(e){return u(c)||S(r.resolved,e),l}function g(e){return o(c)||S(r.rejected,e),l}function y(){return a(c)&&(h=this,T(t.resolved,arguments)),l}function b(){return a(c)&&(h=this,T(t.rejected,arguments)),l}function w(e){return S(r.always,e),l}function E(){return c}function S(t,n){a(c)?p[t].push(n):e.apply(h,[n,d]).fail(l.reject)}function x(e){var t,n;for(t=0,n=e.length;t<n;t++)e[t].apply(h,d);e.splice(0,e.length)}function T(n,i){c=n,d=i,e(function(){x(p[n===t.resolved?r.resolved:r.rejected]),x(p[r.always])}).fail(l.reject)}function N(e,t,n){return function(){try{var s;n&&i(n)&&(s=n.apply(this,arguments)),s=s!==undefined&&[s]||arguments,C.call(this,e,s,t)}catch(o){e.reject(o)}}}function C(e,t,r){var o=t[0];if(o===e)throw new TypeError;o!==null&&(i(o)||s(o))&&i(o.then)?o.then.call(o,N(e,n.resolve),N(e,n.reject)):e[r].apply(this,t)}l=l||{};var c=t.pending,h=this,p={always:[],resolved:[],rejected:[]},d;return l.always=w,l.done=m,l.fail=g,l.resolve=y,l.reject=b,l.then=v,l.state=E,l}var t={pending:0,resolved:1,rejected:2},n={resolve:"resolve",reject:"reject"},r={always:"always",resolved:"resolved",rejected:"rejected"};return f.states=t,f.async=e,f}),define("src/when",["src/promise"],function(e){function t(){function a(){o&&o--,o||n.resolve.apply(r,u===1?t[0]:t)}function f(e){return function(){t[e]=arguments,r=this,a()}}function l(){n.reject.apply(this,arguments)}function c(){try{u=o=t.length;for(i=0;i<u;i++)s=t[i],s&&typeof s.then=="function"?s.then(f(i),l):(t[i]=s,a())}catch(e){l(e)}}var t=Array.prototype.slice.call(arguments),n=e(),r=this,i,s,o,u;return t.length?(setTimeout(c,1),n):n.resolve(null)}return t}),define("src/deferred",["src/promise"],function(e){function t(){var t=e();return{promise:t,resolve:t.resolve,reject:t.reject}}return t}),define("src/spromise",["src/promise","src/when","src/deferred"],function(e,t,n){return e.when=t,e.deferred=n,e});