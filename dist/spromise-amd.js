/**
 * spromise Copyright (c) 2014 Miguel Castillo.
 * Licensed under MIT
 */

define("src/async",[],function(){function n(){function a(t){return function(){try{var n=t.apply(i,e[0]);o&&o(n)}catch(r){u&&u(r)}}}var e=Array.prototype.slice.call(arguments),n=e.shift(),r=!0,i=this,s={},o,u;return typeof n=="boolean"&&(r=n,n=e.shift()),s.fail=function(t){return u=t,s},s.success=function(t){return o=t,s},s.run=function(r){return t(a(r||n)),s},r?s.run():s}var e=this,t;return e.setImmediate?t=e.setImmediate:e.process&&typeof e.process.nextTick=="function"?t=e.process.nextTick:t=function(e){setTimeout(e,0)},n}),define("src/promise",["src/async"],function(e){function i(e,r){function o(e,t){return i.link(e,t)}function u(n){return i.queue(t.resolved,n),e}function a(n){return i.queue(t.rejected,n),e}function f(t){return i.queue(n.always,t),e}function l(){return i.transition(t.resolved,this,arguments),e}function c(){return i.transition(t.rejected,this,arguments),e}function h(){return i._state}e=e||{};var i=new s(e,r||{});return e.always=f,e.done=u,e.fail=a,e.resolve=l,e.reject=c,e.then=o,e.state=h,e}function s(e,t){this.promise=e,this.state=t.state,this.value=t.value,this.context=t.context}function o(e){this.promise=e,this.count=0}var t={pending:0,resolved:1,rejected:2},n={always:0,resolved:1,rejected:2},r={resolve:"resolve",reject:"reject"};return s.prototype.queue=function(t,n){this.state?this.state===t&&e.call(this.context,n,this.value):(this.deferred||(this.deferred=[])).push({type:t,cb:n})},s.prototype.notify=function(t){var r=this.deferred,i=this.context,s=this.value,o=e.apply(i,[!1,void 0,s]),u,a,f;for(u=0,a=r.length;u<a;u++)f=r[u],(f.type===t||f.type===n.always)&&o.run(f.cb);this.deferred=null},s.prototype.transition=function(e,t,n){this.state||(this.state=e,this.context=t,this.value=n,this.deferred&&this.notify(e))},s.prototype.link=function(e,n){var s,u;return e=typeof e=="function"?e:null,n=typeof n=="function"?n:null,!e&&this.state===t.resolved||!n&&this.state===t.rejected?u=new i({},this):(u=new i,s=new o(u),this.queue(t.resolved,s.chain(r.resolve,e||n)),this.queue(t.rejected,s.chain(r.resolve,n||e))),u},o.prototype.chain=function(e,t){var n=this;return function(){if(n.count++)return;var i;try{t&&(i=t.apply(this,arguments)),i=i!==void 0&&[i]||arguments,n.resolution(e,i)}catch(s){n.promise.reject(s)}}},o.prototype.resolution=function(e,t){var n=t[0],i=n&&n.then,s=typeof n;if(n===this.promise)throw new TypeError;if((s==="function"||s==="object"&&n!==null)&&typeof i=="function"){var u=new o(this.promise);i.call(n,u.chain(r.resolve),u.chain(r.reject))}else this.promise[e].apply(this,t)},i.states=t,i}),define("src/when",["src/promise","src/async"],function(e,t){function n(){function f(){u&&u--,u||r.resolve.apply(i,a===1?n[0]:n)}function l(e){return function(){n[e]=arguments,f()}}function c(){r.reject.apply(this,arguments)}function h(){try{a=u=n.length;for(s=0;s<a;s++)o=n[s],o&&typeof o.then=="function"?o.then(l(s),c):(n[s]=o,f())}catch(e){c(e)}}var n=Array.prototype.slice.call(arguments),r=e(),i=this,s,o,u,a;return n.length?(t(h),r):r.resolve(null)}return n}),define("src/spromise",["src/promise","src/async","src/when"],function(e,t,n){return e.when=n,e.async=t,e});